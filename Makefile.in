CXXFLAGS=@CXXFLAGS@ -Wall @UUINC@ @DEFS@

##DODEBUG=1
#ifdef DODEBUG
#CXXFLAGS=-Wall -g -fexceptions -O -pg -static
#LDLIBS+=/usr/src/donut/zlib-1.1.3/libz.a
##LDLIBS=-lc_g -lm_g
#else
#CXXFLAGS=-Wall -g -fexceptions -O2
#LDLIBS+=-lz
#endif

#if you want to store header cache in text instead of binary.
#text cache files will be slightly larger, but you can view them easier.
#however, gzgets() is _really_ slow, so it takes about 10x longer to load
#nevermind, now I use my own buffered gets func, which in fact seems to be even
#faster than using the binary cache
#CXXFLAGS+=-DTEXT_CACHE
#use configure's --disable-text_cache to switch it, if you want to save a few bytes. 


CXX=@CXX@
LIBS=@LIBS@

srcdir=@srcdir@

prefix=@prefix@
exec_prefix=@exec_prefix@
bindir=@bindir@
mandir=@mandir@
install=@INSTALL@

all: .autostuff nget ngetlite

OBJS=nget.o prot_nntp.o sockstuff.o cache.o file.o misc.o myregex.o datfile.o etree.o nrange.o log.o @EXTRAOBJS@ @UULIB@
nget: $(OBJS) .depend 
	$(CXX) $(CXXFLAGS) $(OBJS) -o $@ $(LIBS)

LITEOBJS=lite.o litenntp.o log.o sockstuff.o
ngetlite: $(LITEOBJS) .depend 
	$(CXX) $(CXXFLAGS) $(LITEOBJS) -o $@
#$(LIBS)
#	egcc $(CXXFLAGS) -o $@ $(OBJS) $(LIBS) -lstdc++ -lefence

@NOUU@@UULIB@:
@NOUU@	(cd @UUDIR@; ./configure)
@NOUU@	make -C @UUDIR@ libuu.a


nrangetest: nrangetest.o file.o sockstuff.o nrange.o log.o
	$(CXX) $(CXXFLAGS) $^ -o $@ $(LIBS)

filetest2: filetest2.o file.o sockstuff.o
	$(CXX) $(CXXFLAGS) $^ -o $@ $(LIBS)

filetest: filetest.o file.o sockstuff.o
#filetest: filetest.o file.o sockstuff.o nrange.o
#filetest: filetest.o myregex.o
	$(CXX) $(CXXFLAGS) $^ -o $@ $(LIBS)

dep depend .depend:
	$(CXX) $(CXXFLAGS) -MM *.cc > .depend

#nana:
#	nana $(CXXFLAGS) *.cc > .nana

install_nget: nget
	$(install) -s -o root -g bin -m 0755 nget $(bindir)
	$(install) -o root -g bin -m 0644 nget.1 $(mandir)/man1

install_ngetlite: ngetlite
	$(install) -s -o root -g bin -m 0755 ngetlite $(bindir)

install: install_nget install_ngetlite


.autostuff: configure config.h.in config.h Makefile config.status

${srcdir}/configure: configure.in aclocal.m4
	cd ${srcdir} && autoconf

# autoheader might not change config.h.in, so touch a stamp file.
${srcdir}/config.h.in: stamp-h.in
${srcdir}/stamp-h.in: configure.in acconfig.h aclocal.m4
#config.h.top config.h.bot
	cd ${srcdir} && autoheader
	echo timestamp > ${srcdir}/stamp-h.in

${srcdir}/config.h: stamp-h
${srcdir}/stamp-h: config.h.in stamp-h.in config.status acconfig.h
	./config.status

Makefile: Makefile.in config.status
	./config.status

config.status: configure
	./config.status --recheck

#dist:
#	-make -C $(UUDIR) distclean
#	cd ..;tar -czhf nget/distro/nget-`egrep "nget v[0-9.]+ -" nget/nget.cc | sed "s/.*v\([0-9.]\+\).*/\1/"`-withuulib.tar.gz nget/README nget/Changelog nget/COPYING nget/*.cc nget/*.h nget/Makefile nget/nget.1 nget/uulib/
#	cd ..;tar -czhf nget/distro/nget-`egrep "nget v[0-9.]+ -" nget/nget.cc | sed "s/.*v\([0-9.]\+\).*/\1/"`.tar.gz nget/README nget/Changelog nget/COPYING nget/*.cc nget/*.h nget/Makefile nget/nget.1
	
clean:
	-rm nget ngetlite *.o
	-make -C uulib clean

distclean: clean
	-rm config.status config.h config.cache config.log Makefile stamp-h .depend *~ .*~
	-make -C uulib distclean
#	-rm *~ config.h config.cache config.log Makefile stamp-h .depend
#	-cp .depend.dist .depend

distclean-killuu: distclean
	-rm -r uulib
		 

#ifeq (.depend,$(wildcard .depend))
include .depend
#endif

.PHONY: all dep depend clean install dist distclean .autostuff
